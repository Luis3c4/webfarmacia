<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/Cliente/inicio.css}">
  <link rel="stylesheet" th:href="@{/css/Cliente/main.css}">
  <link rel="stylesheet" th:href="@{/css/Cliente/cart.css}">
</head>
<body>
  <header>
    <div class="container">
      <div class="logo-nombre">
        <img th:src="@{/imagenes/logo.png}" alt="Logo" class="logo">
        <span class="nombre-empresa">FARMA</span>
      </div>
      <nav>
        <a th:href="@{/inicio}" class="active">Inicio</a>
        <a th:href="@{/productos}">Productos</a>
        <a th:href="@{/contacto}">Contacto</a>
      </nav>
      <div class="acciones-header">
       <button class="login-btn" id="loginBtnHeader" th:onclick="|window.location.href='@{/login}'|">
          <span class="material-symbols-rounded">person</span>
          Iniciar sesión
       </button>
        <button class="carrito-btn">
          <span class="material-symbols-rounded">shopping_cart</span>
          <span class="carrito-contador">0</span>
        </button>
        <div class="usuario-logeado" id="userInfoHeader" style="display:none;">
          <span class="material-symbols-rounded usuario-icono">person</span>
          <span id="userNameHeader" class="usuario-nombre"></span>
          <button id="logoutBtnHeader" class="logout-icon-btn" title="Cerrar sesión">
            <span class="material-symbols-rounded">logout</span>
          </button>
        </div>
      </div>
    </div>
  </header>
  
<section class="slider">
    <button class="nav left">❮</button>
    <div class="carousel">
      <img th:src="@{/imagenes/cliente/banner/banner_01.avif}" class="slide active" alt="Banner 1">
      <img th:src="@{/imagenes/cliente/banner/banner_02.png}" class="slide" alt="Banner 2">
    </div>
    <button class="nav right">❯</button>
  </section>

  <section class="productos-destacados">
    <h2>Productos en Ofertas</h2>
    <div class="carrusel-productos">
      <button class="slide-btn left" onclick="document.getElementById('productosSlider').scrollBy({left:-320,behavior:'smooth'})">❮</button>
      <div class="productos-slider" id="productosSlider">
        <!-- Skeleton loader para productos en ofertas -->
        <div class="skeleton-productos" id="skeletonOfertas">
          <div class="skeleton-product"></div>
          <div class="skeleton-product"></div>
          <div class="skeleton-product"></div>
          <div class="skeleton-product"></div>
        </div>
      </div>
      <button class="slide-btn right" onclick="document.getElementById('productosSlider').scrollBy({left:320,behavior:'smooth'})">❯</button>
    </div>
  </section>
  <section class="seccion-marcas">
    <div class="contenedor-marca">
      <div class="banner-marca">
        <!-- Corregido: Añadido /cliente/ a la ruta y asumiendo Productos_Dove -->
        <img th:src="@{/imagenes/cliente/Productos_Dove/shampoo-seco-ppal.jpg}" alt="Productos Destacados">
        <div class="texto-banner">
          <h2>Productos de Limpieza</h2>
          <button class="ver-mas" onclick="window.location.href='/productos'">Ver más productos</button>
        </div>
      </div>
  
<div class="carrusel-productos">
  <button class="slide-btn left" onclick="document.getElementById('sliderDove').scrollBy({left:-320,behavior:'smooth'})">❮</button>
  <div class="productos-slider" id="sliderDove">
    <!-- Skeleton loader para productos destacados -->
    <div class="skeleton-productos" id="skeletonDestacados">
      <div class="skeleton-product"></div>
      <div class="skeleton-product"></div>
      <div class="skeleton-product"></div>
      <div class="skeleton-product"></div>
    </div>
  </div>
  <button class="slide-btn right" onclick="document.getElementById('sliderDove').scrollBy({left:320,behavior:'smooth'})">❯</button>
      </div>
    </div>
  </section>
  <section class="ofertas">

    <div class="oferta">
      <!-- Corregido: Añadido /cliente/ a la ruta -->
      <img th:src="@{/imagenes/cliente/ofertas/oferta_1.avif}" alt="PediaSure Pack">
      <button class="btn-agregar">＋</button>
    </div>
    <div class="oferta">
      <!-- Corregido: Añadido /cliente/ a la ruta -->
      <img th:src="@{/imagenes/cliente/ofertas/oferta_2.avif}" alt="Huggies Promoción">
      <button class="btn-agregar">＋</button>
    </div>
  </section>
  
  <!-- SIDEBAR DEL CARRITO -->
  <div id="cart-sidebar" class="cart-sidebar">
    <div class="cart-header">
      <h3><span class="material-symbols-rounded">shopping_cart</span> Mi carrito (<span id="cart-count-sidebar">0</span>)</h3>
      <button id="close-cart-btn" class="close-cart-btn" aria-label="Cerrar carrito">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    <div id="cart-items-container" class="cart-items-container">
      <!-- Los items del carrito se insertarán aquí por JavaScript -->
    </div>
    <div class="cart-summary">
      <div class="summary-row">
        <span>Subtotal</span>
        <span id="cart-subtotal">S/ 0.00</span>
      </div>
      <div class="summary-row total-row">
        <span>Total</span>
        <strong id="cart-total">S/ 0.00</strong>
      </div>
    </div>
    <div class="cart-actions">
      <a th:href="@{/carrito}" class="view-cart-btn">Ir a mi carrito</a>
      <button class="checkout-now-btn">Comprar ahora</button>
    </div>
  </div>
  <div id="cart-overlay" class="cart-overlay"></div>

  <footer class="footer">
    <div class="footer-col">
      <h4><span class="material-symbols-rounded">account_balance_wallet</span> Monedero del Ahorro</h4>
      <p>Programa Apoyo al Paciente</p>
      <p>Catálogo del mes</p>
      <p>Productos Equivalentes</p>
      <p>Call Center - Términos</p>
      <p>WhatsApp - Términos</p>
    </div>
    <div class="footer-col">
      <h4><span class="material-symbols-rounded">support_agent</span> Contáctanos</h4>
      <p>Nuestras boticas</p>
      <p>Información Médica</p>
      <p>Consultas y Sugerencias</p>
      <p>Zona de cobertura</p>
      <p>Central Telefónica</p>
    </div>
    <div class="footer-col">
      <h4><span class="material-symbols-rounded">share</span> Síguenos</h4>
      <p><span class="material-symbols-rounded">public</span> Facebook</p>
      <p><span class="material-symbols-rounded">photo_camera</span> Instagram</p>
      <p><span class="material-symbols-rounded">chat</span> WhatsApp</p>
    </div>
    <div class="footer-col">
      <h4><span class="material-symbols-rounded">location_on</span> Ubicación</h4>
      <p>Av. Salud 123, Lima, Perú</p>
    </div>
  </footer>
  
  <!-- Scripts -->
  <script th:src="@{/js/cliente/auth.js}"></script>
  <script th:src="@{/js/cliente/cart.js}"></script>
  <script th:src="@{/js/cliente/cart-sync.js}"></script>
  <script th:src="@{/js/inicio.js}"></script>
  <style>
    .skeleton-productos {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
    }
    .skeleton-product {
      width: 200px;
      height: 320px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 400% 100%;
      animation: skeleton-loading 1.2s infinite linear;
      border-radius: 1rem;
    }
    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
  </style>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Lanzar ambas cargas en paralelo
    Promise.all([loadProductosOfertas(), loadProductosDestacados()]);

    function renderProductos(productos, containerId, skeletonId) {
      const container = document.getElementById(containerId);
      const skeleton = document.getElementById(skeletonId);
      skeleton.style.display = 'none';
      if (!productos || productos.length === 0) {
        container.innerHTML = '<div class="no-productos"><p>No hay productos para mostrar en este momento.</p></div>';
        return;
      }
      // Usar fragmento para mejorar el rendimiento
      const fragment = document.createDocumentFragment();
      productos.forEach(producto => {
        const div = document.createElement('div');
        div.className = 'producto';
        div.setAttribute('data-id', producto.productoId);
        div.setAttribute('data-nombre', producto.nombre);
        div.setAttribute('data-precio', producto.precio_unitario);
        div.setAttribute('data-imagen', producto.imgUrl || '/imagenes/productos/default-medicine.jpg');
        div.setAttribute('data-presentacion', producto.descripcion || 'Sin descripción');
        div.setAttribute('data-categoria', producto.categoria || 'Sin categoría');
        div.style.cursor = 'pointer';
        div.onclick = () => window.location.href = `/producto/detalle/${producto.productoId}`;
        div.innerHTML = `
          <img src="${producto.imgUrl || '/imagenes/productos/default-medicine.jpg'}" 
               alt="${producto.nombre}" 
               loading="lazy"
               onerror="this.src='/imagenes/productos/default-medicine.jpg'" />
          <p class="etiqueta">${producto.categoria || 'Sin categoría'}</p>
          <h3>${producto.nombre}</h3>
          <p class="marca">FARMA</p>
          <div class="precios">
            ${producto.descuento && producto.descuento > 0 ? 
              `<p class="precio-regular">S/ ${(producto.precio_unitario + producto.descuento).toFixed(2)}</p>
               <p class="precio-descuento">S/ ${(producto.precio_unitario + producto.descuento * 0.9).toFixed(2)}</p>
               <p class="precio-final">S/ ${producto.precio_unitario.toFixed(2)}</p>` :
              `<p class="precio-final">S/ ${producto.precio_unitario.toFixed(2)}</p>`
            }
          </div>
          <div class="delivery-icons">
            <span class="material-symbols-rounded">local_shipping</span>
            <span class="material-symbols-rounded">store</span>
          </div>
          ${producto.stock <= 0 ? `
            <div class="stock-status">
              <span class="stock-agotado">
                <span class="material-symbols-rounded">cancel</span>
                Agotado
              </span>
            </div>
            <button class="add-to-cart disabled" disabled>
              <span class="material-symbols-rounded">cancel</span>
              Agotado
            </button>
          ` : producto.stock > 0 && producto.stock <= 10 ? `
            <div class="stock-status">
              <span class="stock-bajo">
                <span class="material-symbols-rounded">warning</span>
                Solo quedan ${producto.stock}
              </span>
            </div>
            <button class="add-to-cart" 
                    data-id="${producto.productoId}" 
                    data-nombre="${producto.nombre}" 
                    data-precio="${producto.precio_unitario}"
                    data-imagen="${producto.imgUrl || '/imagenes/productos/default-medicine.jpg'}"
                    data-presentacion="${producto.descripcion || 'Sin descripción'}"
                    data-categoria="${producto.categoria || 'Sin categoría'}">
              Agregar al carrito
            </button>
          ` : `
            <button class="add-to-cart" 
                    data-id="${producto.productoId}" 
                    data-nombre="${producto.nombre}" 
                    data-precio="${producto.precio_unitario}"
                    data-imagen="${producto.imgUrl || '/imagenes/productos/default-medicine.jpg'}"
                    data-presentacion="${producto.descripcion || 'Sin descripción'}"
                    data-categoria="${producto.categoria || 'Sin categoría'}">
              Agregar al carrito
            </button>
          `}
        `;
        fragment.appendChild(div);
      });
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    function loadProductosOfertas() {
      const skeleton = document.getElementById('skeletonOfertas');
      skeleton.style.display = 'flex';
      return fetch('/api/productos/ofertas?page=0&size=10')
        .then(response => response.json())
        .then(data => {
          const productos = data.content || data;
          renderProductos(productos, 'productosSlider', 'skeletonOfertas');
        })
        .catch(error => {
          console.error('Error cargando productos en ofertas:', error);
          skeleton.style.display = 'none';
          document.getElementById('productosSlider').innerHTML = '<div class="no-productos"><p>Error al cargar productos en ofertas.</p></div>';
        });
    }

    function loadProductosDestacados() {
      const skeleton = document.getElementById('skeletonDestacados');
      skeleton.style.display = 'flex';
      return fetch('/api/productos/categoria/Limpieza?page=0&size=8')
        .then(response => response.json())
        .then(data => {
          const productos = data.content || data;
          renderProductos(productos, 'sliderDove', 'skeletonDestacados');
        })
        .catch(error => {
          console.error('Error cargando productos destacados:', error);
          skeleton.style.display = 'none';
          document.getElementById('sliderDove').innerHTML = '<div class="no-productos"><p>Error al cargar productos destacados.</p></div>';
        });
    }
  });
  </script>
</body>
</html>